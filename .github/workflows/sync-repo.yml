name: è‡ªåŠ¨åŒæ­¥æŒ‡å®šé¡¹ç›®

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 2 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: false
        default: 'microsoft/vscode'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯åç§°'
        required: false
        default: 'synced-main'

env:
  # é…ç½®è¦åŒæ­¥çš„æºä»“åº“
  SOURCE_REPO: ${{ github.event.inputs.source_repo || 'microsoft/vscode' }}
  SOURCE_BRANCH: 'main'
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'synced-main' }}

jobs:
  sync-repo:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºå½“å‰ä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: é…ç½® Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: æ·»åŠ æºä»“åº“ä¸ºè¿œç¨‹æº
      run: |
        git remote add upstream https://github.com/${{ env.SOURCE_REPO }}.git
        git remote -v

    - name: è·å–æºä»“åº“æœ€æ–°å†…å®¹
      run: |
        git fetch upstream ${{ env.SOURCE_BRANCH }}

    - name: æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
      id: check_branch
      run: |
        if git show-ref --verify --quiet refs/heads/${{ env.TARGET_BRANCH }}; then
          echo "branch_exists=true" >> $GITHUB_OUTPUT
        else
          echo "branch_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»ºæˆ–åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
      run: |
        if [ "${{ steps.check_branch.outputs.branch_exists }}" = "true" ]; then
          git checkout ${{ env.TARGET_BRANCH }}
        else
          git checkout -b ${{ env.TARGET_BRANCH }} upstream/${{ env.SOURCE_BRANCH }}
        fi

    - name: åŒæ­¥æœ€æ–°æ›´æ”¹
      run: |
        if [ "${{ steps.check_branch.outputs.branch_exists }}" = "true" ]; then
          # å¦‚æœåˆ†æ”¯å·²å­˜åœ¨ï¼Œè¿›è¡Œåˆå¹¶
          git merge upstream/${{ env.SOURCE_BRANCH }} --no-edit
        fi

    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      id: check_changes
      run: |
        if [ "${{ steps.check_branch.outputs.branch_exists }}" = "true" ]; then
          if git diff --quiet HEAD~1; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: æ¨é€æ›´æ”¹
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git push origin ${{ env.TARGET_BRANCH }}

    - name: åˆ›å»ºåŒæ­¥æŠ¥å‘Š
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "## åŒæ­¥æŠ¥å‘Š ğŸ“‹" >> sync_report.md
        echo "" >> sync_report.md
        echo "**åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> sync_report.md
        echo "**æºä»“åº“**: ${{ env.SOURCE_REPO }}" >> sync_report.md
        echo "**æºåˆ†æ”¯**: ${{ env.SOURCE_BRANCH }}" >> sync_report.md
        echo "**ç›®æ ‡åˆ†æ”¯**: ${{ env.TARGET_BRANCH }}" >> sync_report.md
        echo "" >> sync_report.md
        echo "### æœ€æ–°æäº¤ä¿¡æ¯" >> sync_report.md
        git log --oneline -10 upstream/${{ env.SOURCE_BRANCH }} >> sync_report.md

    - name: è¾“å‡ºåŒæ­¥çŠ¶æ€
      run: |
        if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… åŒæ­¥å®Œæˆï¼å‘ç°å¹¶åŒæ­¥äº†æ–°çš„æ›´æ”¹ã€‚"
        else
          echo "ğŸ“„ å·²æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€åŒæ­¥ã€‚"
        fi

    - name: æ¸…ç†è¿œç¨‹æº
      run: |
        git remote remove upstream

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: sync-repo
    if: failure()
    
    steps:
    - name: å‘é€å¤±è´¥é€šçŸ¥
      run: |
        echo "âŒ åŒæ­¥å¤±è´¥ï¼"
        echo "ä»“åº“: ${{ env.SOURCE_REPO }}"
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
