name: è‡ªåŠ¨åŒæ­¥æŒ‡å®šé¡¹ç›®

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 2 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: false
        default: 'microsoft/vscode'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯åç§°'
        required: false
        default: 'synced-main'
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: false
        default: 'merge'
        type: choice
        options:
          - merge
          - replace

env:
  # é…ç½®è¦åŒæ­¥çš„æºä»“åº“
  SOURCE_REPO: ${{ github.event.inputs.source_repo || 'microsoft/vscode' }}
  SOURCE_BRANCH: 'main'
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'synced-main' }}
  SYNC_MODE: ${{ github.event.inputs.sync_mode || 'merge' }}

jobs:
  sync-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºå½“å‰ä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true

    - name: é…ç½® Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # éªŒè¯ token æƒé™
        echo "éªŒè¯ GitHub Token æƒé™..."
        if ! git ls-remote origin >/dev/null 2>&1; then
          echo "âŒ æ— æ³•è®¿é—®ä»“åº“ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®"
          exit 1
        fi
        echo "âœ… Token æƒé™éªŒè¯é€šè¿‡"

    - name: æ·»åŠ æºä»“åº“ä¸ºè¿œç¨‹æº
      run: |
        git remote add upstream https://github.com/${{ env.SOURCE_REPO }}.git
        git remote -v

    - name: è·å–æºä»“åº“æœ€æ–°å†…å®¹
      run: |
        git fetch upstream ${{ env.SOURCE_BRANCH }}

    - name: æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
      id: check_branch
      run: |
        if git show-ref --verify --quiet refs/heads/${{ env.TARGET_BRANCH }}; then
          echo "branch_exists=true" >> $GITHUB_OUTPUT
        else
          echo "branch_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»ºæˆ–åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
      run: |
        if [ "${{ steps.check_branch.outputs.branch_exists }}" = "true" ]; then
          git checkout ${{ env.TARGET_BRANCH }}
        else
          git checkout -b ${{ env.TARGET_BRANCH }} upstream/${{ env.SOURCE_BRANCH }}
        fi

    - name: åŒæ­¥æœ€æ–°æ›´æ”¹ï¼ˆå®Œå…¨æ’é™¤.githubç›®å½•ï¼‰
      run: |
        if [ "${{ steps.check_branch.outputs.branch_exists }}" = "true" ]; then
          if [ "${{ env.SYNC_MODE }}" = "replace" ]; then
            # æ›¿æ¢æ¨¡å¼ï¼šé‡ç½®åˆ°æºåˆ†æ”¯ä½†å®Œå…¨æ’é™¤.githubç›®å½•
            echo "ğŸ”„ ä½¿ç”¨æ›¿æ¢æ¨¡å¼åŒæ­¥ï¼ˆå®Œå…¨æ’é™¤.githubç›®å½•ï¼‰"
            
            # å¤‡ä»½å½“å‰.githubç›®å½•
            if [ -d ".github" ]; then
              cp -r .github /tmp/github-backup
              echo "âœ… å·²å¤‡ä»½.githubç›®å½•"
            fi
            
            # é‡ç½®åˆ°ä¸Šæ¸¸åˆ†æ”¯
            git reset --hard upstream/${{ env.SOURCE_BRANCH }}
            
            # å®Œå…¨ç§»é™¤æºä»“åº“çš„.githubç›®å½•
            if [ -d ".github" ]; then
              rm -rf .github
              echo "ğŸ—‘ï¸ å·²ç§»é™¤æºä»“åº“çš„.githubç›®å½•"
            fi
            
            # æ¢å¤æˆ‘ä»¬è‡ªå·±çš„.githubç›®å½•
            if [ -d "/tmp/github-backup" ]; then
              cp -r /tmp/github-backup .github
              git add .github/
              echo "âœ… å·²æ¢å¤æœ¬åœ°.githubç›®å½•"
            fi
          else
            # åˆå¹¶æ¨¡å¼ï¼šæ‰‹åŠ¨åˆå¹¶ï¼Œå®Œå…¨æ’é™¤.githubç›®å½•
            echo "ğŸ”„ ä½¿ç”¨åˆå¹¶æ¨¡å¼åŒæ­¥ï¼ˆå®Œå…¨æ’é™¤.githubç›®å½•ï¼‰"
            
            # å¤‡ä»½å½“å‰.githubç›®å½•
            if [ -d ".github" ]; then
              cp -r .github /tmp/github-backup
              echo "âœ… å·²å¤‡ä»½.githubç›®å½•"
            fi
            
            # è·å–ä¸Šæ¸¸åˆ†æ”¯çš„æ–‡ä»¶åˆ—è¡¨ï¼Œæ’é™¤.githubç›®å½•
            git checkout upstream/${{ env.SOURCE_BRANCH }} -- . || true
            
            # ç§»é™¤ä»»ä½•æ¥è‡ªæºä»“åº“çš„.githubç›®å½•
            if [ -d ".github" ]; then
              rm -rf .github
              echo "ğŸ—‘ï¸ å·²ç§»é™¤æºä»“åº“çš„.githubç›®å½•"
            fi
            
            # æ¢å¤æˆ‘ä»¬è‡ªå·±çš„.githubç›®å½•
            if [ -d "/tmp/github-backup" ]; then
              cp -r /tmp/github-backup .github
              git add .
              echo "âœ… å·²æ¢å¤æœ¬åœ°.githubç›®å½•"
            fi
          fi
        fi

    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      id: check_changes
      run: |
        # è·å–å½“å‰ HEAD çš„ SHA
        current_sha=$(git rev-parse HEAD)
        upstream_sha=$(git rev-parse upstream/${{ env.SOURCE_BRANCH }})
        
        echo "å½“å‰åˆ†æ”¯ SHA: $current_sha"
        echo "ä¸Šæ¸¸åˆ†æ”¯ SHA: $upstream_sha"
        
        if [ "$current_sha" = "$upstream_sha" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "sync_status=up_to_date" >> $GITHUB_OUTPUT
          echo "âœ… åŒæ­¥çŠ¶æ€: å·²æ˜¯æœ€æ–°"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "sync_status=updated" >> $GITHUB_OUTPUT
          echo "ğŸ”„ åŒæ­¥çŠ¶æ€: å‘ç°æ›´æ–°"
        fi

    - name: æ¨é€æ›´æ”¹
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # ä½¿ç”¨æ ‡å‡†çš„git pushï¼Œé¿å…å·¥ä½œæµæ–‡ä»¶æƒé™é—®é¢˜
        git push origin ${{ env.TARGET_BRANCH }} --force-with-lease

    - name: åˆ›å»ºåŒæ­¥æŠ¥å‘Š
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "## ğŸ”„ åŒæ­¥æŠ¥å‘Š" >> sync_report.md
        echo "" >> sync_report.md
        echo "**åŒæ­¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> sync_report.md
        echo "**æºä»“åº“**: [${{ env.SOURCE_REPO }}](https://github.com/${{ env.SOURCE_REPO }})" >> sync_report.md
        echo "**æºåˆ†æ”¯**: \`${{ env.SOURCE_BRANCH }}\`" >> sync_report.md
        echo "**ç›®æ ‡åˆ†æ”¯**: \`${{ env.TARGET_BRANCH }}\`" >> sync_report.md
        echo "**åŒæ­¥æ¨¡å¼**: \`${{ env.SYNC_MODE }}\`" >> sync_report.md
        echo "" >> sync_report.md
        
        # æ˜¾ç¤ºæäº¤å·®å¼‚ç»Ÿè®¡
        echo "### ğŸ“Š å˜æ›´ç»Ÿè®¡" >> sync_report.md
        if [ "${{ steps.check_branch.outputs.branch_exists }}" = "true" ]; then
          commits_ahead=$(git rev-list --count HEAD..upstream/${{ env.SOURCE_BRANCH }} 2>/dev/null || echo "0")
          commits_behind=$(git rev-list --count upstream/${{ env.SOURCE_BRANCH }}..HEAD 2>/dev/null || echo "0")
          echo "- é¢†å…ˆæºä»“åº“: $commits_behind ä¸ªæäº¤" >> sync_report.md
          echo "- è½åæºä»“åº“: $commits_ahead ä¸ªæäº¤" >> sync_report.md
        fi
        
        echo "" >> sync_report.md
        echo "### ğŸ“ æœ€æ–°æäº¤ (æœ€è¿‘5ä¸ª)" >> sync_report.md
        echo "\`\`\`" >> sync_report.md
        git log --oneline -5 upstream/${{ env.SOURCE_BRANCH }} >> sync_report.md
        echo "\`\`\`" >> sync_report.md

    - name: è¾“å‡ºåŒæ­¥çŠ¶æ€
      run: |
        if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… åŒæ­¥å®Œæˆï¼å‘ç°å¹¶åŒæ­¥äº†æ–°çš„æ›´æ”¹ã€‚"
          echo "ğŸ”„ åŒæ­¥æ¨¡å¼: ${{ env.SYNC_MODE }}"
          echo "ğŸ“ æºä»“åº“: ${{ env.SOURCE_REPO }}"
        else
          echo "ğŸ“„ å·²æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€åŒæ­¥ã€‚"
          echo "ğŸ“ æºä»“åº“: ${{ env.SOURCE_REPO }}"
        fi

    - name: æ¸…ç†è¿œç¨‹æº
      run: |
        git remote remove upstream

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: sync-repo
    if: failure()
    
    steps:
    - name: å‘é€å¤±è´¥é€šçŸ¥
      run: |
        echo "âŒ åŒæ­¥å¤±è´¥ï¼"
        echo "ä»“åº“: ${{ env.SOURCE_REPO }}"
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "å¸¸è§é—®é¢˜æ’æŸ¥ï¼š"
        echo "1. æ£€æŸ¥ä»“åº“çš„ Actions æƒé™è®¾ç½®"
        echo "2. ç¡®ä¿ Workflow permissions è®¾ç½®ä¸º 'Read and write permissions'"
        echo "3. éªŒè¯æºä»“åº“ ${{ env.SOURCE_REPO }} æ˜¯å¦å¯è®¿é—®"
        echo "4. å¦‚æœæºä»“åº“åŒ…å«å·¥ä½œæµæ–‡ä»¶ï¼Œç¡®ä¿å·²æ·»åŠ  'actions: write' æƒé™"
        echo ""
        echo "æƒé™è®¾ç½®è·¯å¾„ï¼šSettings â†’ Actions â†’ General â†’ Workflow permissions"
        echo ""
        echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
